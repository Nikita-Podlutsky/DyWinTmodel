import torch
import torch.nn as nn
import torch.nn.functional as F
import random

#######################################################################
# 1. –†–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (Sparse Alignment)
#######################################################################

def generate_sparse_alignment(phonemes, durations, mask_token_id, keep_random=True):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ö–æ–¥–Ω—ã—Ö —Ñ–æ–Ω–µ–º –∏ –∏—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π.
    
    –î–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ–Ω–µ–º—ã –∏–∑ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
      - –ü–æ–≤—Ç–æ—Ä—è–µ–º –µ—ë d_i —Ä–∞–∑ (–≥–¥–µ d_i ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–æ–Ω–µ–º—ã).
      - –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–æ–Ω–µ–º—ã —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ (—è–∫–æ—Ä—å).
      - –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ mask_token_id.
    
    –ü—Ä–∏–º–µ—Ä:
      phonemes = [1, 2, 3]
      durations = [2, 2, 3]
      –í–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: [M, 1, 2, M, M, M, 3] (–≥–¥–µ M = mask_token_id)
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
      phonemes: —Å–ø–∏—Å–æ–∫ —Ñ–æ–Ω–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, [1, 2, 3])
      durations: —Å–ø–∏—Å–æ–∫ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ–Ω–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, [2, 2, 3])
      mask_token_id: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0)
      keep_random: –µ—Å–ª–∏ True, —è–∫–æ—Ä—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ–Ω–µ–º—ã;
                   –µ—Å–ª–∏ False, –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è –ø–æ–∑–∏—Ü–∏—è.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
      –°–ø–∏—Å–æ–∫ –¥–ª–∏–Ω—ã sum(durations), –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ.
    """
    sparse_alignment = []
    for p, d in zip(phonemes, durations):
        anchor_index = random.randint(0, d - 1) if keep_random else 0
        for i in range(d):
            if i == anchor_index:
                sparse_alignment.append(p)
            else:
                sparse_alignment.append(mask_token_id)
    return sparse_alignment

#######################################################################
# 2. –ü–æ–Ω–∏–∂–∞—é—â–∞—è –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ª–∞—Ç–µ–Ω—Ç–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º
#######################################################################

class AlignmentDownsampler(nn.Module):
    def __init__(self, vocab_size, embedding_dim, out_dim, target_length):
        """
        –ú–æ–¥—É–ª—å –¥–ª—è –ø–æ–Ω–∏–∂–∞—é—â–µ–π –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.
        
        –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π:
          1. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ñ–æ–Ω–µ–º –≤ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏.
          2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–≤—ë—Ä—Ç–æ—á–Ω–æ–≥–æ —Å–ª–æ—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
          3. –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–æ —Ü–µ–ª–µ–≤–æ–π –¥–ª–∏–Ω—ã (–¥–ª–∏–Ω–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è).
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
          vocab_size: —Ä–∞–∑–º–µ—Ä —Å–ª–æ–≤–∞—Ä—è —Ñ–æ–Ω–µ–º.
          embedding_dim: —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.
          out_dim: —á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø–æ—Å–ª–µ —Å–≤—ë—Ä—Ç–æ—á–Ω–æ–≥–æ —Å–ª–æ—è.
          target_length: —Ü–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª–∏–Ω–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è z).
        """
        super(AlignmentDownsampler, self).__init__()
        self.embedding = nn.Embedding(num_embeddings=vocab_size, embedding_dim=embedding_dim)
        # –°–≤—ë—Ä—Ç–æ—á–Ω—ã–π —Å–ª–æ–π —Å kernel_size=3; padding=1 —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Å–∏
        self.conv = nn.Conv1d(in_channels=embedding_dim, out_channels=out_dim, kernel_size=3, padding=1)
        self.target_length = target_length

    def forward(self, token_ids):
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏, —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∏ –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ—Ç.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
          token_ids: —Ç–µ–Ω–∑–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ (batch_size, seq_length).
          
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
          –¢–µ–Ω–∑–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ (batch_size, out_dim, target_length).
        """
        x = self.embedding(token_ids)            # (batch, seq_length, embedding_dim)
        x = x.transpose(1, 2)                      # (batch, embedding_dim, seq_length)
        x = self.conv(x)                           # (batch, out_dim, seq_length)
        # –ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º –¥–æ target_length, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –¥–ª–∏–Ω–µ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        x = F.interpolate(x, size=self.target_length, mode='linear', align_corners=False)
        return x

class SDiTAlignment(nn.Module):
    def __init__(self, vocab_size, embedding_dim, alignment_out_dim, target_length):
        """
        –ú–æ–¥—É–ª—å –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–µ—á–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–±–æ–π –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–ª—É—á–µ–Ω–Ω–æ–π –∏–∑ —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
          vocab_size: —Ä–∞–∑–º–µ—Ä —Å–ª–æ–≤–∞—Ä—è —Ñ–æ–Ω–µ–º.
          embedding_dim: —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.
          alignment_out_dim: —á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –æ—Ç AlignmentDownsampler.
          target_length: —Ü–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Å–∏ (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –¥–ª–∏–Ω–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è).
        """
        super(SDiTAlignment, self).__init__()
        self.downsampler = AlignmentDownsampler(vocab_size, embedding_dim, alignment_out_dim, target_length)

    def forward(self, z, token_ids):
        """
        –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ z –∏ –ø–æ–Ω–∏–∂–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
          z: –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—á–∏, —Ç–µ–Ω–∑–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ (batch, latent_channels, T).
          token_ids: —Ç–µ–Ω–∑–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ (batch, seq_length) —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.
          
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
          –¢–µ–Ω–∑–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ (batch, latent_channels + alignment_out_dim, T).
        """
        a_down = self.downsampler(token_ids)  # (batch, alignment_out_dim, T)
        z_aligned = torch.cat([z, a_down], dim=1)
        return z_aligned

#######################################################################
# 3. PeRFlow: –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –û–î–£ (Piecewise Error-Rectified Flow)
#######################################################################

def sigma(t):
    """
    –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —à—É–º–∞ sigma(t).
    
    –ó–¥–µ—Å—å –∑–∞–¥–∞—ë—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –ª–∏–Ω–µ–π–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –Ω–æ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
      t: –≤—Ä–µ–º—è (—Å–∫–∞–ª—è—Ä –∏–ª–∏ —Ç–µ–Ω–∑–æ—Ä)
      
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
      –ó–Ω–∞—á–µ–Ω–∏–µ sigma –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ t.
    """
    return 0.1 + 0.9 * t

def phi_theta(z_start, t_start, t_end):
    """
    –°–∏–º—É–ª–∏—Ä—É–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –û–î–£ –æ—Ç t_start –¥–æ t_end —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ—à–∞—Ç–µ–ª—è phi_theta.
    
    –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ phi_theta ‚Äî —ç—Ç–æ –æ–±—É—á–µ–Ω–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤–∞—è –º–æ–¥–µ–ª—å, –∑–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–µ–π—à–∞—è —ç–≤–æ–ª—é—Ü–∏—è.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
      z_start: –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –º–æ–º–µ–Ω—Ç t_start.
      t_start: –Ω–∞—á–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.
      t_end: –∫–æ–Ω–µ—á–Ω–æ–µ –≤—Ä–µ–º—è.
      
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
      –≠–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ z –≤ –º–æ–º–µ–Ω—Ç t_end.
    """
    dt = t_end - t_start
    # –õ–∏–Ω–µ–π–Ω–∞—è —ç–≤–æ–ª—é—Ü–∏—è —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–µ–±–æ–ª—å—à–æ–≥–æ —à—É–º–∞:
    return z_start + dt * 0.5 + torch.randn_like(z_start) * 0.01

class VHat(nn.Module):
    def __init__(self, channel_dim):
        """
        –ú–æ–¥–µ–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –¥—Ä–µ–π—Ñ–æ–≤–æ–π —Å–∏–ª—ã v_{\hat{\theta}}.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏-—É—á–µ–Ω–∏–∫–∞ —Å —Ü–µ–ª—å—é –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
          channel_dim: —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑–º–µ—Ä –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è).
        """
        super(VHat, self).__init__()
        self.fc = nn.Linear(channel_dim, channel_dim)
    
    def forward(self, z_t, t):
        """
        –ü—Ä—è–º–æ–π –ø—Ä–æ—Ö–æ–¥ –º–æ–¥–µ–ª–∏ –æ—Ü–µ–Ω–∫–∏.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
          z_t: –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ t.
          t: –≤—Ä–µ–º—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–æ –≤ –≤–∏–¥–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏; –∑–¥–µ—Å—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —è–≤–Ω–æ).
          
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
          –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—É—é –¥—Ä–µ–π—Ñ–æ–≤—É—é —Å–∏–ª—É.
        """
        return self.fc(z_t)

def perflow_loss(v_hat, z_t, z_tk, z_tk_minus1, t, t_k, t_k_minus1):
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç —Ü–µ–ª–µ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±—É—á–µ–Ω–∏—è PeRFlow.
    
    –¶–µ–ª–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
      ‚Ñì = || v_{\hat{Œ∏}}(z_t, t) - (z_{t_k} - z_{t_{k-1}}) / (t_k - t_{k-1}) ||¬≤
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
      v_hat: –º–æ–¥–µ–ª—å –æ—Ü–µ–Ω–∫–∏ –¥—Ä–µ–π—Ñ–æ–≤–æ–π —Å–∏–ª—ã v_{\hat{Œ∏}}.
      z_t: –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ, –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ t ‚àà (t_k_minus1, t_k].
      z_tk: –∫–æ–Ω–µ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∫–Ω–∞, –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Ä–µ—à–∞—Ç–µ–ª–µ–º phi_theta.
      z_tk_minus1: –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∫–Ω–∞.
      t: –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ (t_k_minus1, t_k].
      t_k, t_k_minus1: –≥—Ä–∞–Ω–∏—Ü—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞.
      
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
      –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å (MSE) –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞.
    """
    dt = t_k - t_k_minus1
    target = (z_tk - z_tk_minus1) / dt
    prediction = v_hat(z_t, t)
    loss = torch.mean((prediction - target) ** 2)
    return loss

#######################################################################
# 4. –ú–Ω–æ–≥–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–µ –±–µ–∑–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (Classifier-Free Guidance, CFG)
#######################################################################

def g_theta(z_t, p, z_prompt):
    """
    –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ g_Œ∏.
    
    –í —Ä–µ–∞–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–ª–æ–∂–Ω—É—é –Ω–µ–π—Ä–æ—Å–µ—Ç—å, –≥–µ–Ω–µ—Ä–∏—Ä—É—é—â—É—é –≤—ã—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
      - –õ–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è z_t.
      - –£—Å–ª–æ–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –¥–ª—è —Ñ–æ–Ω–µ–º (p).
      - –£—Å–ª–æ–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–∏–∫—Ç–æ—Ä–∞ (z_prompt).
    
    –ï—Å–ª–∏ –∫–∞–∫–æ–µ-–ª–∏–±–æ —É—Å–ª–æ–≤–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤–º–µ—Å—Ç–æ –Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 0.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
      z_t: –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
      p: —É—Å–ª–æ–≤–∏–µ –¥–ª—è —Ñ–æ–Ω–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —ç–º–±–µ–¥–¥–∏–Ω–≥).
      z_prompt: —É—Å–ª–æ–≤–∏–µ –¥–∏–∫—Ç–æ—Ä–∞.
      
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
      –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
    """
    cond_p = p if p is not None else 0
    cond_z = z_prompt if z_prompt is not None else 0
    return z_t + cond_p + cond_z

def multi_component_cfg(z_t, p, z_prompt, alpha_spk, alpha_txt):
    """
    –†–µ–∞–ª–∏–∑—É–µ—Ç –º–Ω–æ–≥–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–µ –±–µ–∑–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.
    
    –§–æ—Ä–º—É–ª–∞:
      ùëîÃÇ_Œ∏(z_t, p, z_prompt) = Œ±_spk [g_Œ∏(z_t, p, z_prompt) - g_Œ∏(z_t, p, ‚àÖ)]
                                + Œ±_txt [g_Œ∏(z_t, p, ‚àÖ) - g_Œ∏(z_t, ‚àÖ, ‚àÖ)]
                                + g_Œ∏(z_t, ‚àÖ, ‚àÖ)
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
      z_t: –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
      p: —É—Å–ª–æ–≤–∏–µ –¥–ª—è —Ñ–æ–Ω–µ–º.
      z_prompt: —É—Å–ª–æ–≤–∏–µ –¥–∏–∫—Ç–æ—Ä–∞.
      alpha_spk: –º–∞—Å—à—Ç–∞–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–∏–∫—Ç–æ—Ä–∞.
      alpha_txt: –º–∞—Å—à—Ç–∞–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —É—Å–ª–æ–≤–∏—è.
      
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
      –ò—Ç–æ–≥–æ–≤—ã–π —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –≤—ã–≤–æ–¥.
    """
    unconditional = g_theta(z_t, None, None)
    g_with_p = g_theta(z_t, p, None)
    g_with_all = g_theta(z_t, p, z_prompt)
    
    guided = (alpha_spk * (g_with_all - g_with_p) +
              alpha_txt * (g_with_p - unconditional) +
              unconditional)
    return guided

#######################################################################
# –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
#######################################################################

if __name__ == "__main__":
    ######################################
    # –®–∞–≥ 1. –†–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
    ######################################
    # –ó–∞–¥–∞—ë–º —Ñ–æ–Ω–µ–º—ã –∏ –∏—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
    phonemes = [1, 2, 3]       # –ü—Ä–∏–º–µ—Ä: —Ñ–æ–Ω–µ–º—ã –∑–∞–¥–∞–Ω—ã –∏—Ö –∏–Ω–¥–µ–∫—Å–∞–º–∏.
    durations = [2, 2, 3]      # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π —Ñ–æ–Ω–µ–º—ã (—Å—É–º–º–∞—Ä–Ω–∞—è –¥–ª–∏–Ω–∞ = 7).
    mask_token_id = 0        # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–∫–µ–Ω–∞ –º–∞—Å–∫–∏.
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ.
    sparse_alignment = generate_sparse_alignment(phonemes, durations, mask_token_id)
    print("–†–∞–∑—Ä–µ–∂—ë–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ:", sparse_alignment)
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Ç–µ–Ω–∑–æ—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º batch —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: (1, seq_length).
    token_ids_tensor = torch.tensor(sparse_alignment).unsqueeze(0)
    
    ######################################
    # –®–∞–≥ 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Å –ª–∞—Ç–µ–Ω—Ç–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º
    ######################################
    batch_size = 1
    latent_channels = 64
    T = sum(durations)  # –û–∂–∏–¥–∞–µ–º–∞—è –¥–ª–∏–Ω–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–∞–≤–Ω–∞ —Å—É–º–º–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7).
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—á–∏ z —Ä–∞–∑–º–µ—Ä–æ–º (batch, latent_channels, T).
    z = torch.randn(batch_size, latent_channels, T)
    
    # –ó–∞–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –º–æ–¥—É–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.
    vocab_size = 100         # –†–∞–∑–º–µ—Ä —Å–ª–æ–≤–∞—Ä—è —Ñ–æ–Ω–µ–º.
    embedding_dim = 32       # –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.
    alignment_out_dim = 16   # –ß–∏—Å–ª–æ –≤—ã—Ö–æ–¥–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø–æ—Å–ª–µ —Å–≤—ë—Ä—Ç–æ—á–Ω–æ–≥–æ —Å–ª–æ—è.
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥—É–ª—å SDiTAlignment.
    sdit_alignment = SDiTAlignment(vocab_size, embedding_dim, alignment_out_dim, target_length=T)
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.
    aligned_z = sdit_alignment(z, token_ids_tensor)
    print("–§–æ—Ä–º–∞ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è:", aligned_z.shape)
    
    # –û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞: (batch, latent_channels + alignment_out_dim, T)
    
    ######################################
    # –®–∞–≥ 3. PeRFlow: –†–µ—à–µ–Ω–∏–µ –û–î–£ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å
    ######################################
    # –ó–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–∞ –¥–ª—è –º–æ–¥–µ–ª–∏ –æ—Ü–µ–Ω–∫–∏ –¥—Ä–µ–π—Ñ–æ–≤–æ–π —Å–∏–ª—ã.
    channel_dim = latent_channels
    v_hat_model = VHat(channel_dim)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞: t ‚àà [t_k_minus1, t_k]
    t_k_minus1 = 0.3
    t_k = 0.5
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ z1 –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞.
    z1 = torch.randn(1, channel_dim)
    epsilon = torch.randn_like(z1)
    
    # –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –º–æ–º–µ–Ω—Ç t_k_minus1 –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
    # z_{t_{k-1}} = sqrt(1 - sigma(t)^2) * z1 + sigma(t) * epsilon
    t = t_k_minus1
    z_tk_minus1 = ((1 - sigma(t)**2)**0.5 * z1) + sigma(t) * epsilon
    
    # –†–µ—à–∞–µ–º –û–î–£ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –º–æ–º–µ–Ω—Ç t_k:
    z_tk = phi_theta(z_tk_minus1, t_k_minus1, t_k)
    
    # –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ z_t –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ):
    z_t = (z_tk_minus1 + z_tk) / 2
    # –î–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–±–∏—Ä–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞:
    t_random = torch.tensor([[ (t_k_minus1 + t_k) / 2 ]])
    
    # –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å PeRFlow:
    loss_value = perflow_loss(v_hat_model, z_t, z_tk, z_tk_minus1, t_random, t_k, t_k_minus1)
    print("PeRFlow loss:", loss_value.item())
    
    ######################################
    # –®–∞–≥ 4. –ú–Ω–æ–≥–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–µ –±–µ–∑–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (CFG)
    ######################################
    
    # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–∞–ª—è—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∏–º–∏—Ç–∏—Ä—É—é—â–∏–µ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏ —É—Å–ª–æ–≤–∏—è.
    z_t_cfg = 1.0       # –õ–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä–Ω–æ, –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–µ–∫—Ç–æ—Ä–æ–º)
    p_condition = 0.5   # –£—Å–ª–æ–≤–∏–µ –¥–ª—è —Ñ–æ–Ω–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —ç–º–±–µ–¥–¥–∏–Ω–≥)
    z_prompt = 0.8      # –£—Å–ª–æ–≤–∏–µ –¥–∏–∫—Ç–æ—Ä–∞
    
    # –ó–∞–¥–∞—ë–º –º–∞—Å—à—Ç–∞–±—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —É—Å–ª–æ–≤–∏–π.
    alpha_spk = 2.0   # –ú–∞—Å—à—Ç–∞–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–∏–∫—Ç–æ—Ä–∞
    alpha_txt = 1.5   # –ú–∞—Å—à—Ç–∞–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —É—Å–ª–æ–≤–∏—è
    
    # –í—ã—á–∏—Å–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –≤—ã–≤–æ–¥ —Å –ø–æ–º–æ—â—å—é –º–Ω–æ–≥–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–≥–æ CFG:
    guided_output = multi_component_cfg(z_t_cfg, p_condition, z_prompt, alpha_spk, alpha_txt)
    print("–í—ã–≤–æ–¥ –º–Ω–æ–≥–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–≥–æ CFG:", guided_output)